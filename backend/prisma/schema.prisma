generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int                   @id @default(autoincrement())
  username             String                @unique
  email                String                @unique
  password             String
  displayName          String?               @map("display_name")
  bio                  String?
  avatarUrl            String?               @map("avatar_url")
  coverPhotoUrl        String?               @map("cover_photo_url")
  role                 String                @default("client")
  status               String                @default("active")
  telegramId           String?               @map("telegram_id")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  socialLinks          Json?                 @default("[]") @map("social_links")
  verified             Boolean               @default(false)
  walletBalance        Float                 @default(0) @map("wallet_balance")
  razorpayContactId    String?               @map("razorpay_contact_id")
  phoneNumber          String?               @map("phone_number")
  city                 String?
  pincode              String?
  activities           ActivityLog[]
  blockedBy            BlockedUser[]         @relation("BlockedByUser")
  blockedUsers         BlockedUser[]         @relation("BlockingUser")
  clientDeals          EscrowDeal[]          @relation("ClientDeals")
  vendorDeals          EscrowDeal[]          @relation("VendorDeals")
  receivedMessages     Message[]             @relation("ReceivedMessages")
  sentMessages         Message[]             @relation("SentMessages")
  notificationReads    NotificationRead[]
  sentNotifications    Notification[]        @relation("SentNotifications")
  targetNotifications  Notification[]        @relation("TargetNotifications")
  payoutRequests       PayoutRequest[]
  ratingsReceived      Rating[]              @relation("RatingsReceived")
  ratingsGiven         Rating[]              @relation("RatingsGiven")
  reportsReceived      Report[]              @relation("ReportsReceived")
  reportsCreated       Report[]              @relation("ReportsCreated")
  verificationRequests VerificationRequest[]
  walletTransactions   WalletTransaction[]

  @@map("users")
}

model Message {
  id             Int      @id @default(autoincrement())
  senderId       Int      @map("sender_id")
  receiverId     Int      @map("receiver_id")
  chatId         String   @map("chat_id")
  content        String
  messageType    String   @default("text") @map("message_type")
  attachmentUrl  String?  @map("attachment_url")
  attachmentName String?  @map("attachment_name")
  read           Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  isDeleted      Boolean  @default(false) @map("is_deleted")
  isOpened       Boolean  @default(false) @map("is_opened")
  isViewOnce     Boolean  @default(false) @map("is_view_once")
  color          String?
  deletedBySender   Boolean  @default(false) @map("deleted_by_sender")
  deletedByReceiver Boolean  @default(false) @map("deleted_by_receiver")
  receiver       User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender         User     @relation("SentMessages", fields: [senderId], references: [id])

  @@map("messages")
}

model Rating {
  id         Int      @id @default(autoincrement())
  reviewerId Int      @map("reviewer_id")
  reviewedId Int      @map("reviewed_id")
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")
  reviewed   User     @relation("RatingsReceived", fields: [reviewedId], references: [id])
  reviewer   User     @relation("RatingsGiven", fields: [reviewerId], references: [id])

  @@unique([reviewerId, reviewedId])
  @@map("ratings")
}

model Report {
  id         Int      @id @default(autoincrement())
  reporterId Int      @map("reporter_id")
  reportedId Int      @map("reported_id")
  reason     String
  status     String   @default("pending")
  createdAt  DateTime @default(now()) @map("created_at")
  reported   User     @relation("ReportsReceived", fields: [reportedId], references: [id])
  reporter   User     @relation("ReportsCreated", fields: [reporterId], references: [id])

  @@map("reports")
}

model BlockedUser {
  id        Int      @id @default(autoincrement())
  blockerId Int      @map("blocker_id")
  blockedId Int      @map("blocked_id")
  createdAt DateTime @default(now()) @map("created_at")
  blocked   User     @relation("BlockedByUser", fields: [blockedId], references: [id])
  blocker   User     @relation("BlockingUser", fields: [blockerId], references: [id])

  @@unique([blockerId, blockedId])
  @@map("blocked_users")
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  action    String
  details   String?
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("activity_log")
}

model EscrowDeal {
  id                Int                 @id @default(autoincrement())
  chatId            String              @map("chat_id")
  clientId          Int                 @map("client_id")
  vendorId          Int                 @map("vendor_id")
  title             String
  description       String?
  totalAmount       Float               @map("total_amount")
  releasedPercent   Float               @default(0) @map("released_percent")
  status            String              @default("pending_payment")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  paidAmount        Float               @default(0) @map("paid_amount")
  paymentStatus     String              @default("pending") @map("payment_status")
  razorpayOrderId   String?             @map("razorpay_order_id")
  razorpayPaymentId String?             @map("razorpay_payment_id")
  terms             String?
  client            User                @relation("ClientDeals", fields: [clientId], references: [id])
  vendor            User                @relation("VendorDeals", fields: [vendorId], references: [id])
  transactions      EscrowTransaction[]

  @@map("escrow_deals")
}

model EscrowTransaction {
  id        Int        @id @default(autoincrement())
  dealId    Int        @map("deal_id")
  percent   Float
  amount    Float
  note      String?
  createdAt DateTime   @default(now()) @map("created_at")
  deal      EscrowDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("escrow_transactions")
}

model VerificationRequest {
  id                Int       @id @default(autoincrement())
  userId            Int       @map("user_id")
  status            String    @default("pending_payment")
  paymentAmount     Float     @map("payment_amount")
  paymentProof      String?   @map("payment_proof")
  adminNote         String?   @map("admin_note")
  createdAt         DateTime  @default(now()) @map("created_at")
  reviewedAt        DateTime? @map("reviewed_at")
  paymentStatus     String    @default("pending") @map("payment_status")
  razorpayOrderId   String?   @map("razorpay_order_id")
  razorpayPaymentId String?   @map("razorpay_payment_id")
  user              User      @relation(fields: [userId], references: [id])

  @@map("verification_requests")
}

model PaymentLog {
  id                Int      @id @default(autoincrement())
  type              String
  entityId          Int      @map("entity_id")
  razorpayOrderId   String?  @map("razorpay_order_id")
  razorpayPaymentId String?  @unique @map("razorpay_payment_id")
  amount            Float
  currency          String   @default("INR")
  status            String
  eventType         String?  @map("event_type")
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("payment_logs")
}

model WalletTransaction {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  type        String
  amount      Float
  balance     Float
  reference   String?
  description String
  createdAt   DateTime @default(now()) @map("created_at")
  metadata    Json?
  user        User     @relation(fields: [userId], references: [id])

  @@map("wallet_transactions")
}

model PayoutRequest {
  id                    Int       @id @default(autoincrement())
  userId                Int       @map("user_id")
  amount                Float
  status                String    @default("pending")
  bankAccount           String?   @map("bank_account")
  ifscCode              String?   @map("ifsc_code")
  accountName           String    @map("account_name")
  razorpayPayoutId      String?   @map("razorpay_payout_id")
  adminNote             String?   @map("admin_note")
  requestedAt           DateTime  @default(now()) @map("requested_at")
  processedAt           DateTime? @map("processed_at")
  paymentMethod         String    @default("bank") @map("payment_method")
  razorpayContactId     String?   @map("razorpay_contact_id")
  razorpayFundAccountId String?   @map("razorpay_fund_account_id")
  upiVpa                String?   @map("upi_vpa")
  phoneNumber           String?   @map("phone_number")
  email                 String?
  user                  User      @relation(fields: [userId], references: [id])

  @@map("payout_requests")
}

model Notification {
  id           Int                @id @default(autoincrement())
  title        String
  message      String
  type         String             @default("info")
  sentBy       Int?               @map("sent_by")
  createdAt    DateTime           @default(now()) @map("created_at")
  targetUserId Int?               @map("target_user_id")
  color        String?
  metadata     Json?
  reads        NotificationRead[]
  admin        User?              @relation("SentNotifications", fields: [sentBy], references: [id])
  targetUser   User?              @relation("TargetNotifications", fields: [targetUserId], references: [id])

  @@map("notifications")
}

model NotificationRead {
  id             Int          @id @default(autoincrement())
  notificationId Int          @map("notification_id")
  userId         Int          @map("user_id")
  readAt         DateTime     @default(now()) @map("read_at")
  isDeleted      Boolean      @default(false) @map("is_deleted")
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@unique([notificationId, userId])
  @@map("notification_reads")
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  email     String
  code      String
  type      String
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("otp_codes")
}

model SystemSetting {
  key   String @id
  value String

  @@map("system_settings")
}
